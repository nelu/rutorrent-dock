version: '2.2'

# with traefik support on /rt/ endpoint

services:

  # apache front
  web:
    extends:
      service: common-service
      file: common.yml
    restart: always
    volumes:
      - tempdir:/tmp:rw
      - persistent_data:/data:rw
      - ./config/rutorrent/config.php:/usr/src/app/conf/config.php:ro
#      - ./config/rutorrent/vhost.conf:/etc/apache2/sites-enabled/000-default.conf
#      - ./config/rutorrent/media.php:/usr/src/app/plugins/filemanager-media/conf.php:ro

      # local dev mount
#     - ./src/build/entrypoint.sh:/usr/local/bin/entrypoint.sh
#      - ${RUTORRENT_SRC_DIR}:/var/www/html

    # uncomment if traefik is not used
    ports:
      - "80:80/tcp"

    expose:
      - 80
    networks:
      default:
        ipv4_address: 172.200.23.2
#      - webgateway  #traefik network
    labels:
       - "traefik.enable=true"
       - "traefik.docker.network=webrouter_gateway"
       - "traefik.http.routers.rutorrent.rule=PathPrefix(`/rt/`)"
       - "traefik.http.routers.rutorrent.entrypoints=web,websecure"
       - "traefik.http.middlewares.strip-rutorrent-prefix.stripprefix.prefixes=/rt/"
       - "traefik.http.middlewares.rutorrentAuth.basicauth.users=admin:$$apr1$$tVlulz88$$ppMBNuyJMWvpcFDZRPuAv1"
       - "traefik.http.middlewares.rutorrentAuth.basicauth.removeheader=true"
       - "traefik.http.routers.rutorrent.middlewares=strip-rutorrent-prefix@docker,rutorrentAuth@docker"

  # jailed rtorrent xml-rpc server
  rtorrent:
    extends:
      service: common-service
      file: common.yml
    command:  gosu runuser sh -c '/bin/rm -rf /data/.session/rtorrent.lock ; exec rtorrent'
    restart: always
    stdin_open: true
    tty: true
    networks:
      default:
        ipv4_address: 172.200.23.3
    volumes_from:
      - web:rw
    volumes:
#      - ./config/rtorrent.conf:/var/www/.rtorrent.rc:rw
      - ./config/rtorrent.conf:/home/runuser/.rtorrent.rc:rw
    expose:
      - "5000"
    ports:
      - "55950-55999:55950-55999/tcp"
      - "55950-55999:55950-55999/udp"


volumes:
  tempdir:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./bt/tmp
  persistent_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./bt/data

networks:
#  webgateway:
#    external:
#      name: webrouter_gateway
  default:
    ipam:
      driver: default
      config:
        - subnet: 172.200.23.0/24
        